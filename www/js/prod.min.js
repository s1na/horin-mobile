"use strict";angular.module("btford.socket-io",[]).provider("socket",function(){var a,b="socket:";this.$get=["$rootScope","$timeout",function(c,d){var e=a||io.connect("http://horin.ir",{"force new connection":!0,"sync disconnect on unload":!0}),f=function(a){return function(){var b=arguments;d(function(){a.apply(e,b)},0)}},g=function(a,b){e.on(a,f(b))},h={on:g,addListener:g,emit:function(a,b,c){c?e.emit(a,b,f(c)):e.emit(a,b)},removeListener:function(){var a=arguments;return e.removeListener.apply(e,a)},forward:function(a,d){a instanceof Array==!1&&(a=[a]),d||(d=c),a.forEach(function(a){var c=b+a,g=f(function(a){d.$broadcast(c,a)});d.$on("$destroy",function(){e.removeListener(a,g)}),e.on(a,g)})}};return h}],this.prefix=function(a){b=a},this.ioSocket=function(b){a=b}});var app=angular.module("talkie",["talkie.controllers","talkie.filters","talkie.services","talkie.directives","btford.socket-io"]);app.config(["$locationProvider",function(a){a.html5Mode(!0)}]),angular.module("talkie.controllers",[]).controller("ChatCtrl",["$rootScope","$scope","$http","$window","$document","socket","userS","notifS","loadingS","titleS","msgS",function(a,b,c,d,e,f,g,h,i,j,k){function l(){b.setStranger({username:"",commonTopics:[],otherTopics:[]}),j.setStranger(""),b.msg.msgs=[],b.msg.curMsg="",b.reported=!1}a.title=j,b.user={},b.stranger=g.stranger,b.msg=k,b.notif=h,b.loading=i,b.reported=!1,d.onfocus=function(){j.removeUnseenMsgs(),j.unseenMsgs=0},e.onblur=d.onblur,e.focus=d.focus,b.init=function(){b.findStranger()},b.getData=function(){var a=g.getUser();"function"==typeof a.then?a.then(function(a){b.user=a}):b.user=a},b.findStranger=function(){l(),i.on(),f.emit("stranger:req")},b.setStranger=function(a){b.stranger.username=a.username,b.stranger.commonTopics=a.commonTopics,b.stranger.otherTopics=a.strangerTopics,b.stranger.commonTopicsString=a.commonTopics&&void 0!==typeof a.commonTopics&&a.commonTopics.length>0?a.commonTopics.join("، "):"",b.stranger.otherTopicsString=a.strangerTopics&&void 0!==typeof a.strangerTopics&&a.strangerTopics.length>0?a.strangerTopics.join("، "):""},b.report=function(){f.emit("stranger:report",{noStranger:!b.stranger.username}),b.reported=!0},b.exit=function(){d.location="/exit"},f.on("stranger:res",function(a){b.setStranger(a),j.setStranger(a),i.trigger()}),f.on("stranger:disconnected",function(){b.msg.msgs.push({text:"نفر مقابل گفتگو را ترک کرد.",from:"server"}),b.stranger.username="",b.stranger.commonTopics=[],b.stranger.otherTopics=[],j.clear()}),f.on("system:error",function(){b.exit()}),f.on("error",function(a){"handshake error"===a&&(d.location="/exit")}),f.on("stranger:err",function(){h.set("مشکلی در پیدا کردن فردی برای شما پیش آمده.","err")})}]).controller("MsgCtrl",["$scope","socket","userS","notifS","titleS",function(a,b,c,d,e){a.strangerTyping=!1,a.sendMsg=function(){var c=a.msg.curMsg;b.emit("msg:send",{msg:c}),a.msg.msgs.push({text:c,from:"me"}),a.msg.curMsg=""},a.typing=function(){var c="typing";a.msg.curMsg||(c="cleared"),b.emit("msg:typing",c)},b.on("msg:recv",function(b){a.msg.msgs.push(b.msg),a.strangerTyping=!1,e.newMsg()}),b.on("msg:failed",function(){d.set("پیام ارسال تشد.","err")}),b.on("msg:strangerTyping",function(b){"typing"==b?a.strangerTyping=!0:"cleared"==b&&(a.strangerTyping=!1)})}]),angular.module("talkie.directives",[]).directive("retPressed",function(){return{restrict:"A",link:function(a,b,c){b.bind("keypress",function(d){b[0].value&&13==d.keyCode&&(d.shiftKey||(d.preventDefault(),a.$apply(function(a){a.$eval(c.retPressed)})))})}}}).directive("scrollBtm",["$window",function(a){return{link:function(b,c){b.$watch("msg.msgs",function(){a.setTimeout(function(){c[0].scrollTop=c[0].scrollHeight},1)},!0)}}}]).directive("getFocus",function(){return{link:function(a,b,c){c.getFocus&&b[0].focus()}}}),angular.module("talkie.filters",[]).filter("trim",function(){return function(a){return a.replace(/^\s+|\s+$/g,"")}}),angular.module("talkie.services",[]).service("userS",["$http","$q",function(a,b){var c;this.stranger={username:"",commonTopics:[],otherTopics:[]},this.fetchUserData=function(){var c=b.defer();return a.get("/api/user-data").success(function(a){c.resolve(a)}).error(function(){}),c.promise},this.getUser=function(){var a=b.defer();return"undefined"==typeof c?this.fetchUserData().then(function(b){return c=b,a.resolve(c),a.promise}):c},this.setStranger=function(a,b,c){this.stranger.username=a,this.stranger.commonTopics=b,this.stranger.otherTopics=c}}]).service("msgS",function(){this.msgs=[],this.curMsg=""}).service("notifS",function(){this.msg=null,this.type="err",this.show=!1,this.set=function(a,b){this.msg=a,this.type=b,this.show=!0},this.clear=function(){this.show=!1,this.msg=null,this.type=null}}).service("loadingS",function(){this.enable=!1,this.on=function(){this.enable=!0},this.off=function(){this.enable=!1},this.trigger=function(){this.enable=!this.enable}}).service("titleS",function(){this.defaultTitle="هورین",this.title=this.defaultTitle,this.unseenMsgs=0,this.setStranger=function(a){a.username?(this.removeUnseenMsgs(),this.title=this.title+" - "+a.username):this.title=this.defaultTitle},this.newMsg=function(){document.hasFocus()||(this.unseenMsgs++,")"===this.title[this.title.length-1]&&this.removeUnseenMsgs(),this.addUnseenMsgs())},this.removeUnseenMsgs=function(){-1!==this.title.indexOf("(")&&(this.title=this.title.slice(0,this.title.indexOf("(")))},this.addUnseenMsgs=function(){this.title=this.title+" ("+this.unseenMsgs+")"},this.clear=function(){this.title=this.defaultTitle}});